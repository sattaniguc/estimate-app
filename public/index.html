<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>見積書作成アプリ - 株式会社丹後王国ブルワリー</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      .print\:hidden { display: none !important; }
      body { background: white; }
      @page { margin: 10mm; size: A4; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const LOGO = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzY2NiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxPR088L3RleHQ+PC9zdmc+';

    function EstimateApp() {
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [saved, setSaved] = useState(false);
      const [error, setError] = useState(null);
      const [showPreview, setShowPreview] = useState(false);
      const [notionConfig] = useState({
        caseDbId: '2e7c631c2f0580ccb614cb9c82fbee44',
        detailDbId: '2e7c631c2f05808f9b56d965daef739e',
        productDbId: '2d2c631c2f0580f9811de2f2eed22baf'
      });
      const [estimateData, setEstimateData] = useState({
        customerName: '', tradeType: '帳合', showRetailPrice: false, notes: '',
        items: {}, customPrices: {}, customProducts: []
      });
      const [beerSelection, setBeerSelection] = useState('');
      const [sausageSelection, setSausageSelection] = useState('');
      const [customProductName, setCustomProductName] = useState('');
      const [customProductPrice, setCustomProductPrice] = useState('');
      const [customProductQuantity, setCustomProductQuantity] = useState(1);
      const [customProductTaxRate, setCustomProductTaxRate] = useState('10%');

      useEffect(() => { fetchProducts(); }, []);

      const fetchProducts = async () => {
        setLoading(true); setError(null);
        try {
          const res = await fetch('/api/products', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productDbId: notionConfig.productDbId })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'データ取得失敗');
          setProducts(data.products); setLoading(false);
        } catch (err) { setError(`取得失敗: ${err.message}`); setLoading(false); }
      };

      const handleBeerSet = (type) => {
        if (beerSelection === type) {
          setBeerSelection('');
          const newItems = { ...estimateData.items };
          products.filter(p => p.category === 'ビール').forEach(p => delete newItems[p.id]);
          setEstimateData(prev => ({ ...prev, items: newItems }));
          return;
        }
        setBeerSelection(type);
        const newItems = { ...estimateData.items };
        products.filter(p => p.category === 'ビール').forEach(product => {
          if (type === '瓶のみ' && product.containerType === '瓶') newItems[product.id] = 24;
          else if (type === '缶のみ' && product.containerType === '缶') newItems[product.id] = 24;
          else if (type === '瓶+缶' && (product.containerType === '瓶' || product.containerType === '缶')) newItems[product.id] = 24;
          else delete newItems[product.id];
        });
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const handleSausageSet = (type) => {
        if (sausageSelection === type) {
          setSausageSelection('');
          const newItems = { ...estimateData.items };
          products.filter(p => p.category === 'ソーセージ').forEach(p => delete newItems[p.id]);
          setEstimateData(prev => ({ ...prev, items: newItems }));
          return;
        }
        setSausageSelection(type);
        const newItems = { ...estimateData.items };
        products.filter(p => p.category === 'ソーセージ').forEach(product => {
          if (type === '冷蔵のみ' && product.storageMethod === '冷蔵') newItems[product.id] = 20;
          else if (type === '冷凍のみ' && product.storageMethod === '冷凍') newItems[product.id] = 20;
          else if (type === '冷蔵+冷凍' && (product.storageMethod === '冷蔵' || product.storageMethod === '冷凍')) newItems[product.id] = 20;
          else delete newItems[product.id];
        });
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const handleQtyChange = (id, qty) => {
        const newItems = { ...estimateData.items };
        if (qty <= 0) delete newItems[id]; else newItems[id] = qty;
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const handlePriceChange = (id, price) => {
        setEstimateData(prev => ({
          ...prev, customPrices: { ...prev.customPrices, [id]: parseFloat(price) || 0 }
        }));
      };

      const addCustomProduct = () => {
        if (!customProductName || !customProductPrice) return alert('商品名と単価を入力');
        const id = `custom_${Date.now()}`;
        const prod = { id, name: customProductName, price: parseFloat(customProductPrice),
          quantity: parseInt(customProductQuantity) || 1, expiryDate: '', janCode: '', taxRate: customProductTaxRate };
        setEstimateData(prev => ({
          ...prev, customProducts: [...prev.customProducts, prod],
          items: { ...prev.items, [id]: prod.quantity },
          customPrices: { ...prev.customPrices, [id]: prod.price }
        }));
        setCustomProductName(''); setCustomProductPrice(''); setCustomProductQuantity(1); setCustomProductTaxRate('10%');
      };

      const removeItem = (id) => {
        const newItems = { ...estimateData.items };
        delete newItems[id];
        const newCustom = estimateData.customProducts.filter(p => p.id !== id);
        setEstimateData(prev => ({ ...prev, items: newItems, customProducts: newCustom }));
      };

      const getPrice = (prod) => {
        if (estimateData.customPrices[prod.id]) return estimateData.customPrices[prod.id];
        return estimateData.tradeType === '帳合' ? prod.priceWholesale : prod.priceDirect;
      };

      const calculateTotals = () => {
        let subtotal = 0, tax8 = 0, tax10 = 0;
        Object.entries(estimateData.items).forEach(([id, qty]) => {
          if (qty > 0) {
            const prod = products.find(p => p.id === id) || estimateData.customProducts.find(p => p.id === id);
            if (prod) {
              const price = getPrice(prod);
              const sub = price * qty;
              subtotal += sub;
              if (prod.taxRate === '8%' || prod.taxRate === '8％') tax8 += Math.round(sub * 0.08);
              else tax10 += Math.round(sub * 0.1);
            }
          }
        });
        return { subtotal, tax8, tax10, tax: tax8 + tax10, total: subtotal + tax8 + tax10 };
      };

      const saveToNotion = async () => {
        if (!estimateData.customerName) return alert('顧客名を入力');
        const items = Object.entries(estimateData.items).filter(([_, qty]) => qty > 0).map(([id, qty]) => {
          const prod = products.find(p => p.id === id) || estimateData.customProducts.find(p => p.id === id);
          return { productId: id.startsWith('custom_') ? null : id, productName: prod.name, quantity: qty,
            customPrice: estimateData.customPrices[id] || null };
        });
        if (items.length === 0) return alert('商品を選択');
        setSaving(true); setError(null);
        try {
          const res = await fetch('/api/save', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              caseDbId: notionConfig.caseDbId, detailDbId: notionConfig.detailDbId,
              customerName: estimateData.customerName, tradeType: estimateData.tradeType,
              items, notes: estimateData.notes, estimateUrl: window.location.origin + window.location.pathname
            })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || '保存失敗');
          setSaving(false); setSaved(true);
          alert(`保存完了\n見積番号: ${data.estimateNumber}`);
          setTimeout(() => setSaved(false), 3000);
        } catch (err) { setError(`保存失敗: ${err.message}`); setSaving(false); }
      };

      const totals = calculateTotals();
      const selected = Object.entries(estimateData.items).filter(([_, qty]) => qty > 0)
        .map(([id, qty]) => ({ product: products.find(p => p.id === id) || estimateData.customProducts.find(p => p.id === id), quantity: qty }))
        .filter(item => item.product);

      if (loading) return <div className="flex items-center justify-center min-h-screen"><div className="text-blue-600">読み込み中...</div></div>;

      if (showPreview) {
        return (
          <div className="min-h-screen bg-white p-4">
            <div className="max-w-4xl mx-auto">
              <button className="mb-2 px-4 py-2 bg-gray-600 text-white rounded-lg print:hidden" onClick={() => setShowPreview(false)}>← 編集</button>
              <button className="mb-2 ml-2 px-4 py-2 bg-blue-600 text-white rounded-lg print:hidden" onClick={() => window.print()}>🖨 印刷/PDF</button>
              <div className="bg-white border-2 border-gray-800 p-4">
                <div className="flex justify-between items-start mb-3">
                  <div className="bg-black text-white px-3 py-1 text-lg font-bold">御見積書</div>
                  <div className="text-right text-xs">
                    <div className="border border-gray-400 px-6 py-1 mb-1">年　月　日</div>
                    <div>(有効期限：発行から1ヶ月)</div>
                  </div>
                </div>
                <div className="flex justify-between mb-3">
                  <div className="flex-1">
                    <div className="border-b-2 border-gray-400 pb-1 mb-2">
                      <span className="text-base">{estimateData.customerName}</span><span className="ml-2">御中</span>
                    </div>
                    <p className="text-xs mb-2">平素は格別のご高配を賜り厚く御礼申し上げます。<br/>下記の通り御見積申し上げます。宜しくお願い申し上げます。</p>
                  </div>
                  <div className="ml-4 flex items-start gap-2">
                    <img src={LOGO} alt="ロゴ" className="w-16 h-16"/>
                    <div className="text-xs">
                      <p className="font-bold">株式会社丹後王国ブルワリー</p>
                      <p>〒627-0133</p>
                      <p>京都府京丹後市弥栄町鳥取123</p>
                      <p>TEL: 0772-65-4193</p>
                      <p>FAX: 0772-65-4194</p>
                    </div>
                  </div>
                </div>
                <div className="border-2 border-gray-800 p-2 mb-3 flex justify-between items-center">
                  <span className="text-base font-bold">御見積金額</span>
                  <span className="text-xl font-bold">¥{totals.total.toLocaleString()} -</span>
                </div>
                <div className="flex justify-end mb-3">
                  <div className="flex gap-2">
                    <div className="border border-gray-400 w-12 h-10"></div>
                    <div className="border border-gray-400 w-12 h-10"></div>
                    <div className="border border-gray-400 w-12 h-10"></div>
                  </div>
                </div>
                <table className="w-full border-collapse border border-gray-300 mb-3 text-xs">
                  <thead className="bg-gray-600 text-white">
                    <tr>
                      <th className="border border-gray-300 px-1 py-1">品目</th>
                      <th className="border border-gray-300 px-1 py-1">数量</th>
                      <th className="border border-gray-300 px-1 py-1">単価</th>
                      <th className="border border-gray-300 px-1 py-1">金額</th>
                      <th className="border border-gray-300 px-1 py-1">賞味期限</th>
                      <th className="border border-gray-300 px-1 py-1">JANコード</th>
                      {estimateData.showRetailPrice && <th className="border border-gray-300 px-1 py-1">希望小売価格</th>}
                    </tr>
                  </thead>
                  <tbody>
                    {selected.map(({ product, quantity }) => (
                      <tr key={product.id}>
                        <td className="border border-gray-300 px-1 py-1">{product.name}</td>
                        <td className="border border-gray-300 px-1 py-1 text-center">{quantity}</td>
                        <td className="border border-gray-300 px-1 py-1 text-center">¥{getPrice(product).toLocaleString()}</td>
                        <td className="border border-gray-300 px-1 py-1 text-center">¥{(getPrice(product) * quantity).toLocaleString()}</td>
                        <td className="border border-gray-300 px-1 py-1 text-center">{product.expiryDate || '-'}</td>
                        <td className="border border-gray-300 px-1 py-1 text-center">{product.janCode || '-'}</td>
                        {estimateData.showRetailPrice && (
                          <td className="border border-gray-300 px-1 py-1 text-center">
                            {product.retailPrice > 0 ? `¥${product.retailPrice.toLocaleString()}` : '-'}
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
                <div className="flex justify-end mb-3">
                  <div className="w-56 text-sm">
                    <div className="flex justify-between border-b py-1"><span>小計（税抜）:</span><span>¥{totals.subtotal.toLocaleString()}</span></div>
                    {totals.tax8 > 0 && <div className="flex justify-between border-b py-1"><span>消費税（8%）:</span><span>¥{totals.tax8.toLocaleString()}</span></div>}
                    {totals.tax10 > 0 && <div className="flex justify-between border-b py-1"><span>消費税（10%）:</span><span>¥{totals.tax10.toLocaleString()}</span></div>}
                    <div className="flex justify-between font-bold py-1 text-base"><span>合計:</span><span>¥{totals.total.toLocaleString()}</span></div>
                  </div>
                </div>
                {estimateData.notes && (
                  <div className="border-t pt-2 mb-2">
                    <p className="text-xs font-bold mb-1">備考：</p>
                    <p className="text-xs whitespace-pre-wrap">{estimateData.notes}</p>
                  </div>
                )}
                <div className="border-t pt-2 text-xs">
                  <p>備考：リードタイム：5日 / 1ロット：24本（ビール混載可能、瓶ビール混載可能）</p>
                  <p className="mt-0.5">送料：1ケース250円(税別)、2ケース～無料(税別)、商品代金11,000円(税別)</p>
                  <p className="mt-0.5">保管方法：【瓶】高温多湿を避けて保管、【缶】常温保管</p>
                  <p className="mt-0.5">※受託生産品：600円～（税別）</p>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h1 className="text-3xl font-bold mb-2">見積書作成</h1>
              <p className="text-gray-600">株式会社丹後王国ブルワリー</p>
            </div>
            {error && <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6"><p className="text-red-800 font-medium">エラー</p><p className="text-red-700 text-sm">{error}</p></div>}
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-xl font-bold mb-4">基本情報</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div><label className="block text-sm font-medium mb-2">顧客名 *</label>
                  <input type="text" className="w-full px-4 py-2 border rounded-lg" placeholder="株式会社〇〇" value={estimateData.customerName} onChange={(e) => setEstimateData(p => ({ ...p, customerName: e.target.value }))} /></div>
                <div><label className="block text-sm font-medium mb-2">取引形態 *</label>
                  <select className="w-full px-4 py-2 border rounded-lg" value={estimateData.tradeType} onChange={(e) => setEstimateData(p => ({ ...p, tradeType: e.target.value }))}>
                    <option value="帳合">帳合</option><option value="直接">直接</option></select></div>
                <div className="flex items-end"><label className="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked={estimateData.showRetailPrice} onChange={(e) => setEstimateData(p => ({ ...p, showRetailPrice: e.target.checked }))} className="w-4 h-4" />
                  <span className="text-sm">希望小売価格を表示</span></label></div>
              </div>
              <div><label className="block text-sm font-medium mb-2">その他記載事項（見積書下部に表示）</label>
                <textarea className="w-full px-4 py-2 border rounded-lg" rows="3" placeholder="配送条件、支払条件など" value={estimateData.notes} onChange={(e) => setEstimateData(p => ({ ...p, notes: e.target.value }))} /></div>
            </div>
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-xl font-bold mb-4">商品セット選択</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><h3 className="font-medium mb-3">ビール（基本数量：24）</h3>
                  <div className="flex flex-col gap-2">
                    {['瓶のみ', '缶のみ', '瓶+缶'].map(t => (
                      <button key={t} className={`px-6 py-3 rounded-lg font-medium ${beerSelection === t ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`} onClick={() => handleBeerSet(t)}>
                        {t} {beerSelection === t && '(クリックで解除)'}</button>
                    ))}</div></div>
                <div><h3 className="font-medium mb-3">ソーセージ（基本数量：20）</h3>
                  <div className="flex flex-col gap-2">
                    {['冷蔵のみ', '冷凍のみ', '冷蔵+冷凍'].map(t => (
                      <button key={t} className={`px-6 py-3 rounded-lg font-medium ${sausageSelection === t ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'}`} onClick={() => handleSausageSet(t)}>
                        {t} {sausageSelection === t && '(クリックで解除)'}</button>
                    ))}</div></div>
              </div>
            </div>
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-xl font-bold mb-4">マスタにない商品を追加</h2>
              <div className="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <div className="md:col-span-2"><label className="block text-sm font-medium mb-2">商品名</label>
                  <input type="text" className="w-full px-4 py-2 border rounded-lg" placeholder="商品名" value={customProductName} onChange={(e) => setCustomProductName(e.target.value)} /></div>
                <div><label className="block text-sm font-medium mb-2">単価</label>
                  <input type="number" className="w-full px-4 py-2 border rounded-lg" placeholder="単価" value={customProductPrice} onChange={(e) => setCustomProductPrice(e.target.value)} /></div>
                <div><label className="block text-sm font-medium mb-2">数量</label>
                  <input type="number" className="w-full px-4 py-2 border rounded-lg" placeholder="数量" value={customProductQuantity} onChange={(e) => setCustomProductQuantity(e.target.value)} /></div>
                <div><label className="block text-sm font-medium mb-2">消費税</label>
                  <select className="w-full px-4 py-2 border rounded-lg" value={customProductTaxRate} onChange={(e) => setCustomProductTaxRate(e.target.value)}>
                    <option value="10%">10%</option><option value="8%">8%</option></select></div>
                <button className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" onClick={addCustomProduct}>追加</button>
              </div>
            </div>
            {selected.length > 0 && (
              <>
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <h2 className="text-xl font-bold mb-4">選択された商品</h2>
                  <div className="space-y-2">
                    {selected.map(({ product, quantity }) => (
                      <div key={product.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div className="flex-1"><h3 className="font-medium">{product.name}</h3></div>
                        <div className="flex items-center gap-3">
                          <div><label className="text-xs text-gray-600">単価</label>
                            <input type="number" className="w-24 px-2 py-1 text-center border rounded" value={estimateData.customPrices[product.id] || getPrice(product)} onChange={(e) => handlePriceChange(product.id, e.target.value)} /></div>
                          <div><label className="text-xs text-gray-600">数量</label>
                            <input type="number" className="w-20 px-2 py-1 text-center border rounded" value={quantity} onChange={(e) => handleQtyChange(product.id, parseInt(e.target.value) || 0)} min="0" /></div>
                          <div className="w-32 text-right font-medium">¥{(quantity * getPrice(product)).toLocaleString()}</div>
                          <button className="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200" onClick={() => removeItem(product.id)}>✕</button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <h2 className="text-xl font-bold mb-4">合計金額</h2>
                  <div className="space-y-2">
                    <div className="flex justify-between text-lg"><span>小計（税抜）:</span><span className="font-medium">¥{totals.subtotal.toLocaleString()}</span></div>
                    {totals.tax8 > 0 && <div className="flex justify-between text-lg"><span>消費税（8%）:</span><span className="font-medium">¥{totals.tax8.toLocaleString()}</span></div>}
                    {totals.tax10 > 0 && <div className="flex justify-between text-lg"><span>消費税（10%）:</span><span className="font-medium">¥{totals.tax10.toLocaleString()}</span></div>}
                    <div className="border-t-2 pt-2"><div className="flex justify-between text-2xl font-bold"><span>合計:</span><span className="text-blue-600">¥{totals.total.toLocaleString()}</span></div></div>
                  </div>
                </div>
                <div className="flex gap-4">
                  <button className="flex-1 px-6 py-4 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400" onClick={saveToNotion} disabled={saving || saved}>
                    {saving ? '保存中...' : saved ? '✓ 保存完了' : '💾 Notionに保存'}</button>
                  <button className="px-6 py-4 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700" onClick={() => setShowPreview(true)}>📄 見積書プレビュー</button>
                </div>
              </>
            )}
          </div>
        </div>
      );
    }
    ReactDOM.render(<EstimateApp />, document.getElementById('app'));
  </script>
</body>
</html>
