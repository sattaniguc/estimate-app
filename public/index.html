<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¦‹ç©æ›¸ä½œæˆã‚¢ãƒ—ãƒª - æ ªå¼ä¼šç¤¾ä¸¹å¾Œç‹å›½ãƒ–ãƒ«ãƒ¯ãƒªãƒ¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      .print\:hidden { display: none !important; }
      body { 
        background: white; 
        margin: 0;
        padding: 0;
      }
      @page { 
        margin: 8mm; 
        size: A4; 
      }
      
      /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç¸®å° */
      table {
        font-size: 9px !important;
      }
      
      /* è¡Œã®é«˜ã•ã‚’èª¿æ•´ */
      table td, table th {
        padding: 2px 4px !important;
        line-height: 1.2 !important;
      }
      
      /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ•ãƒƒã‚¿ãƒ¼ã‚’ç¸®å° */
      .text-xl { font-size: 14px !important; }
      .text-lg { font-size: 12px !important; }
      .text-base { font-size: 10px !important; }
      .text-sm { font-size: 9px !important; }
      .text-xs { font-size: 8px !important; }
      
      /* ãƒšãƒ¼ã‚¸ãƒ–ãƒ¬ãƒ¼ã‚¯åˆ¶å¾¡ */
      table { page-break-inside: auto; }
      tr { page-break-inside: avoid; page-break-after: auto; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const LOGO = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzY2NiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxPR088L3RleHQ+PC9zdmc+';

    function EstimateApp() {
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [saved, setSaved] = useState(false);
      const [error, setError] = useState(null);
      const [showPreview, setShowPreview] = useState(false);
      const [viewMode, setViewMode] = useState('create'); // 'create' or 'view'
      const [loadedEstimate, setLoadedEstimate] = useState(null);
      const [notionConfig] = useState({
        caseDbId: '2e7c631c2f0580ccb614cb9c82fbee44',
        detailDbId: '2e7c631c2f05808f9b56d965daef739e',
        productDbId: '2d2c631c2f0580f9811de2f2eed22baf'
      });
      const [estimateData, setEstimateData] = useState({
        customerName: '', tradeType: 'å¸³åˆ', showRetailPrice: false, notes: '',
        items: {}, customPrices: {}, customProducts: []
      });
      const [beerSelection, setBeerSelection] = useState('');
      const [sausageSelection, setSausageSelection] = useState('');
      const [customProductName, setCustomProductName] = useState('');
      const [customProductPrice, setCustomProductPrice] = useState('');
      const [customProductQuantity, setCustomProductQuantity] = useState(1);
      const [customProductTaxRate, setCustomProductTaxRate] = useState('10%');

      useEffect(() => { 
        fetchProducts();
        checkUrlParams();
      }, []);

      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦è¦‹ç©æ›¸IDãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿
      const checkUrlParams = () => {
        const params = new URLSearchParams(window.location.search);
        const estimateId = params.get('estimateId');
        if (estimateId) {
          loadEstimate(estimateId);
        }
      };

      // è¦‹ç©æ›¸ã‚’èª­ã¿è¾¼ã‚€
      const loadEstimate = async (estimateId) => {
        setLoading(true);
        setError(null);
        try {
          const res = await fetch('/api/load-estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              caseDbId: notionConfig.caseDbId,
              detailDbId: notionConfig.detailDbId,
              productDbId: notionConfig.productDbId,
              estimateNumber: estimateId 
            })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'è¦‹ç©æ›¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          
          setLoadedEstimate(data);
          setEstimateData(data.estimateData);
          setViewMode('view');
          setShowPreview(true);
          setLoading(false);
        } catch (err) {
          setError(`èª­ã¿è¾¼ã¿å¤±æ•—: ${err.message}`);
          setLoading(false);
          setViewMode('create');
        }
      };

      const fetchProducts = async () => {
        setLoading(true); 
        setError(null);
        try {
          const res = await fetch('/api/products', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productDbId: notionConfig.productDbId })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—');
          setProducts(data.products); 
          setLoading(false);
        } catch (err) { 
          setError(`å–å¾—å¤±æ•—: ${err.message}`); 
          setLoading(false); 
        }
      };

      const handleBeerSet = (type) => {
        if (beerSelection === type) {
          setBeerSelection('');
          const newItems = { ...estimateData.items };
          products.filter(p => p.category === 'ãƒ“ãƒ¼ãƒ«').forEach(p => delete newItems[p.id]);
          setEstimateData(prev => ({ ...prev, items: newItems }));
          return;
        }
        setBeerSelection(type);
        const newItems = { ...estimateData.items };
        products.filter(p => p.category === 'ãƒ“ãƒ¼ãƒ«').forEach(product => {
          if (type === 'ç“¶ã®ã¿' && product.containerType === 'ç“¶') newItems[product.id] = 24;
          else if (type === 'ç¼¶ã®ã¿' && product.containerType === 'ç¼¶') newItems[product.id] = 24;
          else if (type === 'ç“¶+ç¼¶' && (product.containerType === 'ç“¶' || product.containerType === 'ç¼¶')) newItems[product.id] = 24;
          else delete newItems[product.id];
        });
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const handleSausageSet = (type) => {
        if (sausageSelection === type) {
          setSausageSelection('');
          const newItems = { ...estimateData.items };
          products.filter(p => p.category === 'ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸').forEach(p => delete newItems[p.id]);
          setEstimateData(prev => ({ ...prev, items: newItems }));
          return;
        }
        setSausageSelection(type);
        const newItems = { ...estimateData.items };
        products.filter(p => p.category === 'ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸').forEach(product => {
          if (type === 'å†·è”µã®ã¿' && product.storageMethod === 'å†·è”µ') newItems[product.id] = 20;
          else if (type === 'å†·å‡ã®ã¿' && product.storageMethod === 'å†·å‡') newItems[product.id] = 20;
          else if (type === 'å†·è”µ+å†·å‡' && (product.storageMethod === 'å†·è”µ' || product.storageMethod === 'å†·å‡')) newItems[product.id] = 20;
          else delete newItems[product.id];
        });
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const handleQtyChange = (id, qty) => {
        const newItems = { ...estimateData.items };
        if (qty <= 0) delete newItems[id]; else newItems[id] = qty;
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const handlePriceChange = (id, price) => {
        setEstimateData(prev => ({
          ...prev, customPrices: { ...prev.customPrices, [id]: parseFloat(price) || 0 }
        }));
      };

      const addCustomProduct = () => {
        if (!customProductName || !customProductPrice) return alert('å•†å“åã¨å˜ä¾¡ã‚’å…¥åŠ›');
        const id = `custom_${Date.now()}`;
        const prod = { 
          id, 
          name: customProductName, 
          price: parseFloat(customProductPrice),
          quantity: parseInt(customProductQuantity) || 1, 
          expiryDate: '', 
          janCode: '', 
          taxRate: customProductTaxRate 
        };
        setEstimateData(prev => ({
          ...prev, 
          customProducts: [...prev.customProducts, prod],
          items: { ...prev.items, [id]: prod.quantity },
          customPrices: { ...prev.customPrices, [id]: prod.price }
        }));
        setCustomProductName(''); 
        setCustomProductPrice(''); 
        setCustomProductQuantity(1); 
        setCustomProductTaxRate('10%');
      };

      const removeItem = (id) => {
        const newItems = { ...estimateData.items };
        delete newItems[id];
        const newCustom = estimateData.customProducts.filter(p => p.id !== id);
        setEstimateData(prev => ({ ...prev, items: newItems, customProducts: newCustom }));
      };

      const getPrice = (prod) => {
        if (estimateData.customPrices[prod.id]) return estimateData.customPrices[prod.id];
        return estimateData.tradeType === 'å¸³åˆ' ? prod.priceWholesale : prod.priceDirect;
      };

      const calculateTotals = () => {
        let subtotal = 0, tax8 = 0, tax10 = 0;
        Object.entries(estimateData.items).forEach(([id, qty]) => {
          if (qty > 0) {
            const prod = products.find(p => p.id === id) || estimateData.customProducts.find(p => p.id === id);
            if (prod) {
              const price = getPrice(prod);
              const sub = price * qty;
              subtotal += sub;
              if (prod.taxRate === '8%' || prod.taxRate === '8ï¼…') tax8 += Math.round(sub * 0.08);
              else tax10 += Math.round(sub * 0.1);
            }
          }
        });
        return { subtotal, tax8, tax10, tax: tax8 + tax10, total: subtotal + tax8 + tax10 };
      };

      const saveToNotion = async () => {
        if (!estimateData.customerName) return alert('é¡§å®¢åã‚’å…¥åŠ›');
        const items = Object.entries(estimateData.items).filter(([_, qty]) => qty > 0).map(([id, qty]) => {
          const prod = products.find(p => p.id === id) || estimateData.customProducts.find(p => p.id === id);
          return { 
            productId: id.startsWith('custom_') ? null : id, 
            productName: prod.name, 
            quantity: qty,
            customPrice: estimateData.customPrices[id] || null 
          };
        });
        if (items.length === 0) return alert('å•†å“ã‚’é¸æŠ');
        
        setSaving(true); 
        setError(null);
        try {
          const res = await fetch('/api/save', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              caseDbId: notionConfig.caseDbId, 
              detailDbId: notionConfig.detailDbId,
              customerName: estimateData.customerName, 
              tradeType: estimateData.tradeType,
              items, 
              notes: estimateData.notes
              // è¦‹ç©æ›¸URLã¯ä¿å­˜å¾Œã«ç”Ÿæˆã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯é€ä¿¡ã—ãªã„
            })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'ä¿å­˜å¤±æ•—');
          
          // ä¿å­˜æˆåŠŸå¾Œã€è¦‹ç©æ›¸URLã‚’æ›´æ–°
          const estimateUrl = `${window.location.origin}${window.location.pathname}?estimateId=${data.estimateNumber}`;
          
          // Notionæ¡ˆä»¶ã«URLã‚’è¿½åŠ ã§ä¿å­˜
          await fetch('/api/update-estimate-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              caseId: data.caseId,
              estimateUrl: estimateUrl
            })
          });
          
          setSaving(false); 
          setSaved(true);
          alert(`ä¿å­˜å®Œäº†\nè¦‹ç©ç•ªå·: ${data.estimateNumber}\n\nè¦‹ç©æ›¸URL:\n${estimateUrl}`);
          
          // URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
          navigator.clipboard.writeText(estimateUrl).then(() => {
            console.log('URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
          });
          
          setTimeout(() => setSaved(false), 3000);
        } catch (err) { 
          setError(`ä¿å­˜å¤±æ•—: ${err.message}`); 
          setSaving(false); 
        }
      };

      const totals = calculateTotals();
      const selected = Object.entries(estimateData.items).filter(([_, qty]) => qty > 0)
        .map(([id, qty]) => ({ 
          product: products.find(p => p.id === id) || estimateData.customProducts.find(p => p.id === id), 
          quantity: qty 
        }))
        .filter(item => item.product);

      if (loading) return (
        <div className="flex items-center justify-center min-h-screen">
          <div className="text-blue-600 text-xl">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      );

      if (showPreview) {
        const displayDate = loadedEstimate?.createdDate || new Date();
        const estimateNumber = loadedEstimate?.estimateNumber || 'DRAFT';
        
        return (
          <div className="min-h-screen bg-white p-4">
            <div className="max-w-4xl mx-auto">
              <div className="print:hidden mb-4 flex gap-2">
                <button 
                  className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700" 
                  onClick={() => {
                    setShowPreview(false);
                    if (viewMode === 'view') {
                      window.history.pushState({}, '', window.location.pathname);
                      setViewMode('create');
                      setLoadedEstimate(null);
                    }
                  }}
                >
                  â† {viewMode === 'view' ? 'æ–°è¦ä½œæˆ' : 'ç·¨é›†'}
                </button>
                <button 
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" 
                  onClick={() => window.print()}
                >
                  ğŸ–¨ å°åˆ·/PDF
                </button>
                {viewMode === 'view' && (
                  <div className="flex-1 text-right">
                    <span className="inline-block px-4 py-2 bg-green-100 text-green-800 rounded-lg font-medium">
                      è¦‹ç©ç•ªå·: {estimateNumber}
                    </span>
                  </div>
                )}
              </div>
              
              <div className="bg-white p-8 border border-gray-300">
                {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                <div className="flex justify-between items-start mb-6">
                  <div className="bg-black text-white px-6 py-2 text-2xl font-bold">
                    å¾¡è¦‹ç©æ›¸
                  </div>
                  <div className="text-right text-sm">
                    <div className="border-2 border-gray-800 px-8 py-2 mb-2 inline-block">
                      {displayDate.getFullYear()}å¹´{displayDate.getMonth() + 1}æœˆ{displayDate.getDate()}æ—¥
                    </div>
                    <div className="text-gray-600">(æœ‰åŠ¹æœŸé™ï¼šç™ºè¡Œã‹ã‚‰1ãƒ¶æœˆ)</div>
                  </div>
                </div>

                {/* é¡§å®¢æƒ…å ±ã¨ä¼šç¤¾æƒ…å ± */}
                <div className="flex justify-between mb-6">
                  <div className="flex-1 pr-8">
                    <div className="border-b-2 border-gray-800 pb-2 mb-4">
                      <span className="text-xl font-medium">{estimateData.customerName}</span>
                      <span className="ml-3 text-lg">å¾¡ä¸­</span>
                    </div>
                    <p className="text-sm text-gray-700 leading-relaxed">
                      å¹³ç´ ã¯æ ¼åˆ¥ã®ã”é«˜é…ã‚’è³œã‚Šåšãå¾¡ç¤¼ç”³ã—ä¸Šã’ã¾ã™ã€‚<br/>
                      ä¸‹è¨˜ã®é€šã‚Šå¾¡è¦‹ç©ç”³ã—ä¸Šã’ã¾ã™ã€‚å®œã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚
                    </p>
                  </div>
                  <div className="flex items-start gap-3">
                    <img src={LOGO} alt="ãƒ­ã‚´" className="w-20 h-20"/>
                    <div className="text-xs leading-relaxed">
                      <p className="font-bold text-sm mb-1">æ ªå¼ä¼šç¤¾ä¸¹å¾Œç‹å›½ãƒ–ãƒ«ãƒ¯ãƒªãƒ¼</p>
                      <p>ã€’627-0133</p>
                      <p>äº¬éƒ½åºœäº¬ä¸¹å¾Œå¸‚å¼¥æ „ç”ºé³¥å–123</p>
                      <p className="mt-1">TEL: 0772-65-4193</p>
                      <p>FAX: 0772-65-4194</p>
                    </div>
                  </div>
                </div>

                {/* è¦‹ç©é‡‘é¡ */}
                <div className="flex justify-between items-center mb-6">
                  <div className="border-4 border-gray-900 p-4 flex-1 flex justify-between items-center mr-6">
                    <span className="text-lg font-bold">å¾¡è¦‹ç©é‡‘é¡</span>
                    <span className="text-3xl font-bold">Â¥{totals.total.toLocaleString()} -</span>
                  </div>
                  <div className="flex gap-2">
                    <div className="border-2 border-gray-400 w-16 h-16"></div>
                    <div className="border-2 border-gray-400 w-16 h-16"></div>
                    <div className="border-2 border-gray-400 w-16 h-16"></div>
                  </div>
                </div>

                {/* å•†å“ãƒ†ãƒ¼ãƒ–ãƒ« */}
                <table className="w-full border-collapse border border-gray-300 mb-3 text-xs">
                  <thead className="bg-gray-900 text-white">
                    <tr>
                      <th className="border border-gray-300 px-1 py-1 text-center">å“ç›®</th>
                      <th className="border border-gray-300 px-1 py-1 text-center">æ•°é‡</th>
                      <th className="border border-gray-300 px-1 py-1 text-center">å˜ä¾¡</th>
                      <th className="border border-gray-300 px-1 py-1 text-center">é‡‘é¡</th>
                      <th className="border border-gray-300 px-1 py-1 text-center">è³å‘³æœŸé™</th>
                      <th className="border border-gray-300 px-1 py-1 text-center">JANã‚³ãƒ¼ãƒ‰</th>
                      {estimateData.showRetailPrice && (
                        <th className="border border-gray-300 px-1 py-1 text-center">å¸Œæœ›å°å£²ä¾¡æ ¼</th>
                      )}
                    </tr>
                  </thead>
                  <tbody>
                    {selected.map(({ product, quantity }) => (
                      <tr key={product.id} className="hover:bg-gray-50">
                        <td className="border border-gray-300 px-1 py-1">{product.name}</td>
                        <td className="border border-gray-300 px-1 py-1 text-center">{quantity}</td>
                        <td className="border border-gray-300 px-1 py-1 text-center">
                          Â¥{getPrice(product).toLocaleString()}
                        </td>
                        <td className="border border-gray-300 px-1 py-1 text-center">
                          Â¥{(getPrice(product) * quantity).toLocaleString()}
                        </td>
                        <td className="border border-gray-300 px-1 py-1 text-center">
                          {product.expiryDate || '-'}
                        </td>
                        <td className="border border-gray-300 px-1 py-1 text-center">
                          {product.janCode || '-'}
                        </td>
                        {estimateData.showRetailPrice && (
                          <td className="border border-gray-300 px-1 py-1 text-center">
                            {product.retailPrice > 0 ? `Â¥${product.retailPrice.toLocaleString()}` : '-'}
                          </td>
                        )}
                      </tr>
                    ))}
                    {/* ç©ºè¡Œã‚’è¿½åŠ ï¼ˆæœ€ä½20è¡Œï¼‰ */}
                    {Array.from({ length: Math.max(0, 20 - selected.length) }).map((_, i) => (
                      <tr key={`empty-${i}`}>
                        <td className="border border-gray-400 px-3 py-2">&nbsp;</td>
                        <td className="border border-gray-400 px-3 py-2">&nbsp;</td>
                        <td className="border border-gray-400 px-3 py-2">&nbsp;</td>
                        <td className="border border-gray-400 px-3 py-2">&nbsp;</td>
                        <td className="border border-gray-400 px-3 py-2">&nbsp;</td>
                        <td className="border border-gray-400 px-3 py-2">&nbsp;</td>
                        {estimateData.showRetailPrice && (
                          <td className="border border-gray-400 px-3 py-2">&nbsp;</td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>

                {/* åˆè¨ˆé‡‘é¡ */}
                <div className="flex justify-end mb-6">
                  <div className="w-80">
                    <div className="flex justify-between border-b border-gray-400 py-2">
                      <span className="font-medium">å°è¨ˆï¼ˆç¨æŠœï¼‰:</span>
                      <span className="font-medium">Â¥{totals.subtotal.toLocaleString()}</span>
                    </div>
                    {totals.tax8 > 0 && (
                      <div className="flex justify-between border-b border-gray-400 py-2">
                        <span className="font-medium">æ¶ˆè²»ç¨ï¼ˆ8%ï¼‰:</span>
                        <span className="font-medium">Â¥{totals.tax8.toLocaleString()}</span>
                      </div>
                    )}
                    {totals.tax10 > 0 && (
                      <div className="flex justify-between border-b border-gray-400 py-2">
                        <span className="font-medium">æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰:</span>
                        <span className="font-medium">Â¥{totals.tax10.toLocaleString()}</span>
                      </div>
                    )}
                    <div className="flex justify-between font-bold py-3 text-lg border-t-2 border-gray-800">
                      <span>åˆè¨ˆ:</span>
                      <span>Â¥{totals.total.toLocaleString()}</span>
                    </div>
                  </div>
                </div>

                {/* å‚™è€ƒ */}
                {estimateData.notes && (
                  <div className="border-t-2 border-gray-800 pt-4">
                    <p className="font-bold mb-2">å‚™è€ƒï¼š</p>
                    <p className="text-sm whitespace-pre-wrap leading-relaxed text-gray-700">
                      {estimateData.notes}
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h1 className="text-3xl font-bold mb-2">è¦‹ç©æ›¸ä½œæˆ</h1>
              <p className="text-gray-600">æ ªå¼ä¼šç¤¾ä¸¹å¾Œç‹å›½ãƒ–ãƒ«ãƒ¯ãƒªãƒ¼</p>
            </div>
            
            {error && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <p className="text-red-800 font-medium">ã‚¨ãƒ©ãƒ¼</p>
                <p className="text-red-700 text-sm">{error}</p>
              </div>
            )}
            
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-xl font-bold mb-4">åŸºæœ¬æƒ…å ±</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium mb-2">é¡§å®¢å *</label>
                  <input 
                    type="text" 
                    className="w-full px-4 py-2 border rounded-lg" 
                    placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡" 
                    value={estimateData.customerName} 
                    onChange={(e) => setEstimateData(p => ({ ...p, customerName: e.target.value }))} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">å–å¼•å½¢æ…‹ *</label>
                  <select 
                    className="w-full px-4 py-2 border rounded-lg" 
                    value={estimateData.tradeType} 
                    onChange={(e) => setEstimateData(p => ({ ...p, tradeType: e.target.value }))}
                  >
                    <option value="å¸³åˆ">å¸³åˆ</option>
                    <option value="ç›´æ¥">ç›´æ¥</option>
                  </select>
                </div>
                <div className="flex items-end">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input 
                      type="checkbox" 
                      checked={estimateData.showRetailPrice} 
                      onChange={(e) => setEstimateData(p => ({ ...p, showRetailPrice: e.target.checked }))} 
                      className="w-4 h-4" 
                    />
                    <span className="text-sm">å¸Œæœ›å°å£²ä¾¡æ ¼ã‚’è¡¨ç¤º</span>
                  </label>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">ãã®ä»–è¨˜è¼‰äº‹é …ï¼ˆè¦‹ç©æ›¸ä¸‹éƒ¨ã«è¡¨ç¤ºï¼‰</label>
                <textarea 
                  className="w-full px-4 py-2 border rounded-lg" 
                  rows="3" 
                  placeholder="é…é€æ¡ä»¶ã€æ”¯æ‰•æ¡ä»¶ãªã©" 
                  value={estimateData.notes} 
                  onChange={(e) => setEstimateData(p => ({ ...p, notes: e.target.value }))} 
                />
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-xl font-bold mb-4">å•†å“ã‚»ãƒƒãƒˆé¸æŠ</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h3 className="font-medium mb-3">ãƒ“ãƒ¼ãƒ«ï¼ˆåŸºæœ¬æ•°é‡ï¼š24ï¼‰</h3>
                  <div className="flex flex-col gap-2">
                    {['ç“¶ã®ã¿', 'ç¼¶ã®ã¿', 'ç“¶+ç¼¶'].map(t => (
                      <button 
                        key={t} 
                        className={`px-6 py-3 rounded-lg font-medium transition ${
                          beerSelection === t 
                            ? 'bg-blue-600 text-white' 
                            : 'bg-gray-100 hover:bg-gray-200'
                        }`} 
                        onClick={() => handleBeerSet(t)}
                      >
                        {t} {beerSelection === t && '(ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤)'}
                      </button>
                    ))}
                  </div>
                </div>
                <div>
                  <h3 className="font-medium mb-3">ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ï¼ˆåŸºæœ¬æ•°é‡ï¼š20ï¼‰</h3>
                  <div className="flex flex-col gap-2">
                    {['å†·è”µã®ã¿', 'å†·å‡ã®ã¿', 'å†·è”µ+å†·å‡'].map(t => (
                      <button 
                        key={t} 
                        className={`px-6 py-3 rounded-lg font-medium transition ${
                          sausageSelection === t 
                            ? 'bg-green-600 text-white' 
                            : 'bg-gray-100 hover:bg-gray-200'
                        }`} 
                        onClick={() => handleSausageSet(t)}
                      >
                        {t} {sausageSelection === t && '(ã‚¯ãƒªãƒƒã‚¯ã§è§£é™¤)'}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-xl font-bold mb-4">ãƒã‚¹ã‚¿ã«ãªã„å•†å“ã‚’è¿½åŠ </h2>
              <div className="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium mb-2">å•†å“å</label>
                  <input 
                    type="text" 
                    className="w-full px-4 py-2 border rounded-lg" 
                    placeholder="å•†å“å" 
                    value={customProductName} 
                    onChange={(e) => setCustomProductName(e.target.value)} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">å˜ä¾¡</label>
                  <input 
                    type="number" 
                    className="w-full px-4 py-2 border rounded-lg" 
                    placeholder="å˜ä¾¡" 
                    value={customProductPrice} 
                    onChange={(e) => setCustomProductPrice(e.target.value)} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">æ•°é‡</label>
                  <input 
                    type="number" 
                    className="w-full px-4 py-2 border rounded-lg" 
                    placeholder="æ•°é‡" 
                    value={customProductQuantity} 
                    onChange={(e) => setCustomProductQuantity(e.target.value)} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">æ¶ˆè²»ç¨</label>
                  <select 
                    className="w-full px-4 py-2 border rounded-lg" 
                    value={customProductTaxRate} 
                    onChange={(e) => setCustomProductTaxRate(e.target.value)}
                  >
                    <option value="10%">10%</option>
                    <option value="8%">8%</option>
                  </select>
                </div>
                <button 
                  className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition" 
                  onClick={addCustomProduct}
                >
                  è¿½åŠ 
                </button>
              </div>
            </div>
            
            {selected.length > 0 && (
              <>
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <h2 className="text-xl font-bold mb-4">é¸æŠã•ã‚ŒãŸå•†å“</h2>
                  <div className="space-y-2">
                    {selected.map(({ product, quantity }) => (
                      <div key={product.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div className="flex-1">
                          <h3 className="font-medium">{product.name}</h3>
                        </div>
                        <div className="flex items-center gap-3">
                          <div>
                            <label className="text-xs text-gray-600">å˜ä¾¡</label>
                            <input 
                              type="number" 
                              className="w-24 px-2 py-1 text-center border rounded" 
                              value={estimateData.customPrices[product.id] || getPrice(product)} 
                              onChange={(e) => handlePriceChange(product.id, e.target.value)} 
                            />
                          </div>
                          <div>
                            <label className="text-xs text-gray-600">æ•°é‡</label>
                            <input 
                              type="number" 
                              className="w-20 px-2 py-1 text-center border rounded" 
                              value={quantity} 
                              onChange={(e) => handleQtyChange(product.id, parseInt(e.target.value) || 0)} 
                              min="0" 
                            />
                          </div>
                          <div className="w-32 text-right font-medium">
                            Â¥{(quantity * getPrice(product)).toLocaleString()}
                          </div>
                          <button 
                            className="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition" 
                            onClick={() => removeItem(product.id)}
                          >
                            âœ•
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <h2 className="text-xl font-bold mb-4">åˆè¨ˆé‡‘é¡</h2>
                  <div className="space-y-2">
                    <div className="flex justify-between text-lg">
                      <span>å°è¨ˆï¼ˆç¨æŠœï¼‰:</span>
                      <span className="font-medium">Â¥{totals.subtotal.toLocaleString()}</span>
                    </div>
                    {totals.tax8 > 0 && (
                      <div className="flex justify-between text-lg">
                        <span>æ¶ˆè²»ç¨ï¼ˆ8%ï¼‰:</span>
                        <span className="font-medium">Â¥{totals.tax8.toLocaleString()}</span>
                      </div>
                    )}
                    {totals.tax10 > 0 && (
                      <div className="flex justify-between text-lg">
                        <span>æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰:</span>
                        <span className="font-medium">Â¥{totals.tax10.toLocaleString()}</span>
                      </div>
                    )}
                    <div className="border-t-2 pt-2">
                      <div className="flex justify-between text-2xl font-bold">
                        <span>åˆè¨ˆ:</span>
                        <span className="text-blue-600">Â¥{totals.total.toLocaleString()}</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div className="flex gap-4">
                  <button 
                    className="flex-1 px-6 py-4 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 transition" 
                    onClick={saveToNotion} 
                    disabled={saving || saved}
                  >
                    {saving ? 'ä¿å­˜ä¸­...' : saved ? 'âœ“ ä¿å­˜å®Œäº†' : 'ğŸ’¾ Notionã«ä¿å­˜'}
                  </button>
                  <button 
                    className="px-6 py-4 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700 transition" 
                    onClick={() => setShowPreview(true)}
                  >
                    ğŸ“„ è¦‹ç©æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      );
    }
    
    ReactDOM.render(<EstimateApp />, document.getElementById('app'));
  </script>
</body>
</html>
