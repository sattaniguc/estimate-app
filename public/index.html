<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¦‹ç©æ›¸ä½œæˆã‚¢ãƒ—ãƒª - æ ªå¼ä¼šç¤¾ä¸¹å¾Œç‹å›½ãƒ–ãƒ«ãƒ¯ãƒªãƒ¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      .print\:hidden { display: none !important; }
      body { background: white; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    function EstimateApp() {
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [saved, setSaved] = useState(false);
      const [error, setError] = useState(null);
      const [showPreview, setShowPreview] = useState(false);
      
      const [notionConfig] = useState({
        caseDbId: '2e7c631c2f0580ccb614cb9c82fbee44',
        detailDbId: '2e7c631c2f05808f9b56d965daef739e',
        productDbId: '2d2c631c2f0580f9811de2f2eed22baf'
      });
      
      const [estimateData, setEstimateData] = useState({
        customerName: '',
        tradeType: 'å¸³åˆ',
        showRetailPrice: false,
        items: {}
      });

      const [beerSelection, setBeerSelection] = useState('');
      const [sausageSelection, setSausageSelection] = useState('');

      useEffect(() => {
        fetchProducts();
      }, []);

      const fetchProducts = async () => {
        setLoading(true);
        setError(null);
        try {
          const response = await fetch('/api/products', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productDbId: notionConfig.productDbId })
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—');
          
          console.log('å–å¾—ã—ãŸå•†å“ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€åˆã®3ä»¶ï¼‰:', data.products.slice(0, 3));
          
          setProducts(data.products);
          setLoading(false);
        } catch (err) {
          setError(`å•†å“ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—: ${err.message}`);
          setLoading(false);
        }
      };

      const handleBeerSetSelection = (type) => {
        setBeerSelection(type);
        const newItems = { ...estimateData.items };
        const beerProducts = products.filter(p => p.category === 'ãƒ“ãƒ¼ãƒ«');
        
        console.log(`ãƒ“ãƒ¼ãƒ«å•†å“æ•°: ${beerProducts.length}, é¸æŠ: ${type}`);
        
        beerProducts.forEach(product => {
          const hasContainer = product.containerType === 'ç“¶' || product.containerType === 'ç¼¶';
          if (!hasContainer) {
            console.log(`å®¹å™¨ã‚¿ã‚¤ãƒ—ãªã—: ${product.name}`);
          }
          
          if (type === 'ç“¶ã®ã¿' && product.containerType === 'ç“¶') {
            newItems[product.id] = 24;
          } else if (type === 'ç¼¶ã®ã¿' && product.containerType === 'ç¼¶') {
            newItems[product.id] = 24;
          } else if (type === 'ç“¶+ç¼¶' && hasContainer) {
            newItems[product.id] = 24;
          } else if (beerProducts.some(p => p.id === product.id)) {
            delete newItems[product.id];
          }
        });
        
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const handleSausageSetSelection = (type) => {
        setSausageSelection(type);
        const newItems = { ...estimateData.items };
        const sausageProducts = products.filter(p => p.category === 'ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸');
        
        console.log(`ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸å•†å“æ•°: ${sausageProducts.length}, é¸æŠ: ${type}`);
        sausageProducts.slice(0, 3).forEach(p => {
          console.log(`å•†å“: ${p.name}, ä¿å­˜æ–¹æ³•: "${p.storageMethod}"`);
        });
        
        sausageProducts.forEach(product => {
          const hasStorage = product.storageMethod === 'å†·è”µ' || product.storageMethod === 'å†·å‡';
          if (!hasStorage) {
            console.log(`ä¿å­˜æ–¹æ³•ãªã—: ${product.name}`);
          }
          
          if (type === 'å†·è”µã®ã¿' && product.storageMethod === 'å†·è”µ') {
            newItems[product.id] = 20;
          } else if (type === 'å†·å‡ã®ã¿' && product.storageMethod === 'å†·å‡') {
            newItems[product.id] = 20;
          } else if (type === 'å†·è”µ+å†·å‡' && hasStorage) {
            newItems[product.id] = 20;
          } else if (sausageProducts.some(p => p.id === product.id)) {
            delete newItems[product.id];
          }
        });
        
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const handleQuantityChange = (productId, quantity) => {
        const newItems = { ...estimateData.items };
        if (quantity <= 0) {
          delete newItems[productId];
        } else {
          newItems[productId] = quantity;
        }
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const removeItem = (productId) => {
        const newItems = { ...estimateData.items };
        delete newItems[productId];
        setEstimateData(prev => ({ ...prev, items: newItems }));
      };

      const getPrice = (product) => {
        return estimateData.tradeType === 'å¸³åˆ' ? product.priceWholesale : product.priceDirect;
      };

      const calculateTotals = () => {
        let subtotal = 0, tax = 0;
        Object.entries(estimateData.items).forEach(([productId, quantity]) => {
          if (quantity > 0) {
            const product = products.find(p => p.id === productId);
            if (product) {
              const price = getPrice(product);
              const itemSubtotal = price * quantity;
              const taxRate = product.taxRate === '10%' || product.taxRate === '10ï¼…' ? 0.1 : 0.08;
              subtotal += itemSubtotal;
              tax += Math.round(itemSubtotal * taxRate);
            }
          }
        });
        return { subtotal, tax, total: subtotal + tax };
      };

      const saveToNotion = async () => {
        if (!estimateData.customerName) return alert('é¡§å®¢åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        const selectedItems = Object.entries(estimateData.items)
          .filter(([_, qty]) => qty > 0)
          .map(([productId, quantity]) => ({
            productId,
            productName: products.find(p => p.id === productId).name,
            quantity
          }));
        if (selectedItems.length === 0) return alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');

        setSaving(true);
        setError(null);
        try {
          const response = await fetch('/api/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              caseDbId: notionConfig.caseDbId,
              detailDbId: notionConfig.detailDbId,
              customerName: estimateData.customerName,
              tradeType: estimateData.tradeType,
              items: selectedItems
            })
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—');
          setSaving(false);
          setSaved(true);
          setTimeout(() => setSaved(false), 3000);
        } catch (err) {
          setError(`ä¿å­˜ã«å¤±æ•—: ${err.message}`);
          setSaving(false);
        }
      };

      const totals = calculateTotals();
      const selectedProducts = Object.entries(estimateData.items)
        .filter(([_, qty]) => qty > 0)
        .map(([productId, quantity]) => ({
          product: products.find(p => p.id === productId),
          quantity
        }))
        .filter(item => item.product);

      if (loading) {
        return (
          <div className="flex items-center justify-center min-h-screen">
            <div className="text-blue-600">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        );
      }

      if (showPreview) {
        return (
          <div className="min-h-screen bg-white p-8">
            <div className="max-w-4xl mx-auto">
              <button
                className="mb-4 px-4 py-2 bg-gray-600 text-white rounded-lg print:hidden"
                onClick={() => setShowPreview(false)}
              >
                â† ç·¨é›†ã«æˆ»ã‚‹
              </button>
              <button
                className="mb-4 ml-2 px-4 py-2 bg-blue-600 text-white rounded-lg print:hidden"
                onClick={() => window.print()}
              >
                ğŸ–¨ å°åˆ·/PDFä¿å­˜
              </button>

              <div className="bg-white border-2 border-gray-300 p-8">
                <h1 className="text-3xl font-bold text-center mb-8">å¾¡è¦‹ç©æ›¸</h1>
                <div className="mb-8">
                  <p className="text-lg">{estimateData.customerName} å¾¡ä¸­</p>
                  <p className="text-right text-sm mt-4">æ ªå¼ä¼šç¤¾ä¸¹å¾Œç‹å›½ãƒ–ãƒ«ãƒ¯ãƒªãƒ¼</p>
                </div>

                <table className="w-full border-collapse border border-gray-300 mb-8">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="border border-gray-300 px-2 py-2 text-center text-sm">å•†å“å</th>
                      <th className="border border-gray-300 px-2 py-2 text-center text-sm">æ•°é‡</th>
                      <th className="border border-gray-300 px-2 py-2 text-center text-sm">å˜ä¾¡</th>
                      <th className="border border-gray-300 px-2 py-2 text-center text-sm">é‡‘é¡</th>
                      <th className="border border-gray-300 px-2 py-2 text-center text-sm">è³å‘³æœŸé™</th>
                      <th className="border border-gray-300 px-2 py-2 text-center text-sm">JANã‚³ãƒ¼ãƒ‰</th>
                      {estimateData.showRetailPrice && (
                        <th className="border border-gray-300 px-2 py-2 text-right text-sm">å¸Œæœ›å°å£²ä¾¡æ ¼</th>
                      )}
                    </tr>
                  </thead>
                  <tbody>
                    {selectedProducts.map(({ product, quantity }) => (
                      <tr key={product.id}>
                        <td className="border border-gray-300 px-2 py-2 text-sm">{product.name}</td>
                        <td className="border border-gray-300 px-2 py-2 text-center text-sm">{quantity}</td>
                        <td className="border border-gray-300 px-2 py-2 text-center text-sm">Â¥{getPrice(product).toLocaleString()}</td>
                        <td className="border border-gray-300 px-2 py-2 text-center text-sm">Â¥{(getPrice(product) * quantity).toLocaleString()}</td>
                        <td className="border border-gray-300 px-2 py-2 text-center text-sm">{product.expiryDate}</td>
                        <td className="border border-gray-300 px-2 py-2 text-center text-sm">{product.janCode}</td>
                        {estimateData.showRetailPrice && (
                          <td className="border border-gray-300 px-2 py-2 text-right text-sm">
                            {product.retailPrice > 0 ? `Â¥${product.retailPrice.toLocaleString()}` : '-'}
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>

                <div className="text-right space-y-2">
                  <div className="text-lg">å°è¨ˆï¼ˆç¨æŠœï¼‰: Â¥{totals.subtotal.toLocaleString()}</div>
                  <div className="text-lg">æ¶ˆè²»ç¨: Â¥{totals.tax.toLocaleString()}</div>
                  <div className="text-2xl font-bold border-t-2 border-gray-300 pt-2">
                    åˆè¨ˆé‡‘é¡: Â¥{totals.total.toLocaleString()}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">è¦‹ç©æ›¸ä½œæˆ</h1>
              <p className="text-gray-600">æ ªå¼ä¼šç¤¾ä¸¹å¾Œç‹å›½ãƒ–ãƒ«ãƒ¯ãƒªãƒ¼</p>
            </div>

            {error && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <p className="text-red-800 font-medium">ã‚¨ãƒ©ãƒ¼</p>
                <p className="text-red-700 text-sm">{error}</p>
              </div>
            )}

            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-xl font-bold mb-4">åŸºæœ¬æƒ…å ±</h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-2">é¡§å®¢å *</label>
                  <input
                    type="text"
                    className="w-full px-4 py-2 border rounded-lg"
                    placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡"
                    value={estimateData.customerName}
                    onChange={(e) => setEstimateData(prev => ({ ...prev, customerName: e.target.value }))}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-2">å–å¼•å½¢æ…‹ *</label>
                  <select
                    className="w-full px-4 py-2 border rounded-lg"
                    value={estimateData.tradeType}
                    onChange={(e) => setEstimateData(prev => ({ ...prev, tradeType: e.target.value }))}
                  >
                    <option value="å¸³åˆ">å¸³åˆ</option>
                    <option value="ç›´æ¥">ç›´æ¥</option>
                  </select>
                </div>
                <div className="flex items-end">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={estimateData.showRetailPrice}
                      onChange={(e) => setEstimateData(prev => ({ ...prev, showRetailPrice: e.target.checked }))}
                      className="w-4 h-4"
                    />
                    <span className="text-sm">å¸Œæœ›å°å£²ä¾¡æ ¼ã‚’è¡¨ç¤º</span>
                  </label>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h2 className="text-xl font-bold mb-4">å•†å“ã‚»ãƒƒãƒˆé¸æŠ</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h3 className="font-medium mb-3">ãƒ“ãƒ¼ãƒ«ï¼ˆåŸºæœ¬æ•°é‡ï¼š24ï¼‰</h3>
                  <div className="flex flex-col gap-2">
                    <button
                      className={`px-6 py-3 rounded-lg font-medium ${
                        beerSelection === 'ç“¶ã®ã¿' ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'
                      }`}
                      onClick={() => handleBeerSetSelection('ç“¶ã®ã¿')}
                    >
                      ç“¶ã®ã¿
                    </button>
                    <button
                      className={`px-6 py-3 rounded-lg font-medium ${
                        beerSelection === 'ç¼¶ã®ã¿' ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'
                      }`}
                      onClick={() => handleBeerSetSelection('ç¼¶ã®ã¿')}
                    >
                      ç¼¶ã®ã¿
                    </button>
                    <button
                      className={`px-6 py-3 rounded-lg font-medium ${
                        beerSelection === 'ç“¶+ç¼¶' ? 'bg-blue-600 text-white' : 'bg-gray-100 hover:bg-gray-200'
                      }`}
                      onClick={() => handleBeerSetSelection('ç“¶+ç¼¶')}
                    >
                      ç“¶+ç¼¶
                    </button>
                  </div>
                </div>

                <div>
                  <h3 className="font-medium mb-3">ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ï¼ˆåŸºæœ¬æ•°é‡ï¼š20ï¼‰</h3>
                  <div className="flex flex-col gap-2">
                    <button
                      className={`px-6 py-3 rounded-lg font-medium ${
                        sausageSelection === 'å†·è”µã®ã¿' ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'
                      }`}
                      onClick={() => handleSausageSetSelection('å†·è”µã®ã¿')}
                    >
                      å†·è”µã®ã¿
                    </button>
                    <button
                      className={`px-6 py-3 rounded-lg font-medium ${
                        sausageSelection === 'å†·å‡ã®ã¿' ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'
                      }`}
                      onClick={() => handleSausageSetSelection('å†·å‡ã®ã¿')}
                    >
                      å†·å‡ã®ã¿
                    </button>
                    <button
                      className={`px-6 py-3 rounded-lg font-medium ${
                        sausageSelection === 'å†·è”µ+å†·å‡' ? 'bg-green-600 text-white' : 'bg-gray-100 hover:bg-gray-200'
                      }`}
                      onClick={() => handleSausageSetSelection('å†·è”µ+å†·å‡')}
                    >
                      å†·è”µ+å†·å‡
                    </button>
                  </div>
                </div>
              </div>
            </div>

            {selectedProducts.length > 0 && (
              <>
                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <h2 className="text-xl font-bold mb-4">é¸æŠã•ã‚ŒãŸå•†å“ï¼ˆæ•°é‡èª¿æ•´å¯èƒ½ï¼‰</h2>
                  <div className="space-y-2">
                    {selectedProducts.map(({ product, quantity }) => (
                      <div key={product.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div className="flex-1">
                          <h3 className="font-medium">{product.name}</h3>
                          <p className="text-sm text-gray-600">å˜ä¾¡: Â¥{getPrice(product).toLocaleString()}</p>
                        </div>
                        <div className="flex items-center gap-3">
                          <input
                            type="number"
                            className="w-24 px-3 py-2 text-center border rounded-lg"
                            value={quantity}
                            onChange={(e) => handleQuantityChange(product.id, parseInt(e.target.value) || 0)}
                            min="0"
                          />
                          <div className="w-32 text-right font-medium">
                            Â¥{(quantity * getPrice(product)).toLocaleString()}
                          </div>
                          <button
                            className="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"
                            onClick={() => removeItem(product.id)}
                            title="å‰Šé™¤"
                          >
                            âœ•
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                  <h2 className="text-xl font-bold mb-4">åˆè¨ˆé‡‘é¡</h2>
                  <div className="space-y-2">
                    <div className="flex justify-between text-lg">
                      <span>å°è¨ˆï¼ˆç¨æŠœï¼‰:</span>
                      <span className="font-medium">Â¥{totals.subtotal.toLocaleString()}</span>
                    </div>
                    <div className="flex justify-between text-lg">
                      <span>æ¶ˆè²»ç¨:</span>
                      <span className="font-medium">Â¥{totals.tax.toLocaleString()}</span>
                    </div>
                    <div className="border-t-2 pt-2">
                      <div className="flex justify-between text-2xl font-bold">
                        <span>åˆè¨ˆ:</span>
                        <span className="text-blue-600">Â¥{totals.total.toLocaleString()}</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex gap-4">
                  <button
                    className="flex-1 px-6 py-4 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400"
                    onClick={saveToNotion}
                    disabled={saving || saved}
                  >
                    {saving ? 'ä¿å­˜ä¸­...' : saved ? 'âœ“ ä¿å­˜å®Œäº†' : 'ğŸ’¾ Notionã«ä¿å­˜'}
                  </button>
                  <button
                    className="px-6 py-4 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700"
                    onClick={() => setShowPreview(true)}
                  >
                    ğŸ“„ è¦‹ç©æ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<EstimateApp />, document.getElementById('app'));
  </script>
</body>
</html>
